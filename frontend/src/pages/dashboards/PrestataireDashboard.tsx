import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import api from '../../services/api';

interface Project {
  id: number;
  titre: string;
  description: string;
  budget: number;
  dateDebut: string;
  dateFin: string;
  statut: 'EN_ATTENTE' | 'EN_COURS' | 'TERMINE' | 'ANNULE';
  client: {
    id: number;
    prenom: string;
    nom: string;
    email: string;
  };
}

interface PrestataireStats {
  totalProjets: number;
  projetsEnCours: number;
  projetsTermines: number;
  chiffreAffaires: number;
  tauxReussite: number;
  noteMoyenne: number;
}

interface AIRecommendation {
  id: number;
  title: string;
  description: string;
  type: 'ANALYSIS' | 'OPTIMIZATION' | 'PREDICTION';
  status: 'PENDING' | 'PROCESSING' | 'COMPLETED';
  result?: string;
  deliveryMethod: 'FRONTEND' | 'EMAIL';
  createdAt: Date;
}

export default function PrestataireDashboard() {
  const [projects, setProjects] = useState<Project[]>([]);
  const [stats, setStats] = useState<PrestataireStats>({
    totalProjets: 0,
    projetsEnCours: 0,
    projetsTermines: 0,
    chiffreAffaires: 0,
    tauxReussite: 0,
    noteMoyenne: 0
  });
  const [aiRecommendations, setAiRecommendations] = useState<AIRecommendation[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const navigate = useNavigate();

  useEffect(() => {
    fetchData();
    loadAIRecommendations();
  }, []);

  const fetchData = async () => {
    try {
      setLoading(true);
      // R√©cup√©rer les projets du prestataire
      const projectsResponse = await api.get('/projects');
      const allProjects = projectsResponse.data;
      
      // Filtrer les projets assign√©s √† ce prestataire
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const myProjects = allProjects.filter((project: Project) => 
        project.statut !== 'EN_ATTENTE' || 
        (project.statut === 'EN_ATTENTE' && Math.random() > 0.7) // Simuler quelques projets en attente
      );
      
      setProjects(myProjects);
      
      // Calculer les statistiques am√©lior√©es
      const totalProjets = myProjects.length;
      const projetsTermines = myProjects.filter((p: any) => p.statut === 'TERMINE').length;
      const chiffreAffaires = myProjects
        .filter((p: any) => p.statut === 'TERMINE')
        .reduce((sum: number, p: any) => sum + p.budget, 0);
      
      const stats: PrestataireStats = {
        totalProjets,
        projetsEnCours: myProjects.filter((p: any) => p.statut === 'EN_COURS').length,
        projetsTermines,
        chiffreAffaires,
        tauxReussite: totalProjets > 0 ? Math.round((projetsTermines / totalProjets) * 100) : 0,
        noteMoyenne: 4.2 + Math.random() * 0.8 // Simulation d'une note entre 4.2 et 5.0
      };
      setStats(stats);
      
    } catch (err: any) {
      setError('Erreur lors du chargement des donn√©es');
      console.error('Error fetching data:', err);
    } finally {
      setLoading(false);
    }
  };

  const loadAIRecommendations = () => {
    // Simulation de recommandations IA
    const recommendations: AIRecommendation[] = [
      {
        id: 1,
        title: "üéØ Analyse de Profil Optimis√©e",
        description: "Analyse IA de votre profil et suggestions d'am√©lioration bas√©es sur les tendances du march√©",
        type: 'ANALYSIS',
        status: 'PENDING',
        deliveryMethod: 'FRONTEND',
        createdAt: new Date()
      },
      {
        id: 2,
        title: "üìä Rapport de Performance Mensuel",
        description: "Rapport d√©taill√© de vos performances avec benchmarks sectoriels",
        type: 'ANALYSIS',
        status: 'COMPLETED',
        result: "Votre profil est 23% plus attractif que la moyenne. Suggestions: ajoutez 2 comp√©tences en React Native.",
        deliveryMethod: 'EMAIL',
        createdAt: new Date(Date.now() - 24 * 60 * 60 * 1000)
      },
      {
        id: 3,
        title: "üîÆ Pr√©diction de Revenus",
        description: "Pr√©visions IA de vos revenus pour les 3 prochains mois",
        type: 'PREDICTION',
        status: 'PROCESSING',
        deliveryMethod: 'FRONTEND',
        createdAt: new Date()
      }
    ];
    setAiRecommendations(recommendations);
  };

  const requestAIService = async (type: string) => {
    try {
      const token = localStorage.getItem('token');
      const newRecommendation: AIRecommendation = {
        id: Date.now(),
        title: `ü§ñ ${type === 'profile' ? 'Analyse de Profil' : type === 'market' ? 'Analyse de March√©' : 'Optimisation SEO'}`,
        description: `Service IA ${type} en cours de g√©n√©ration...`,
        type: 'ANALYSIS',
        status: 'PROCESSING',
        deliveryMethod: Math.random() > 0.5 ? 'FRONTEND' : 'EMAIL',
        createdAt: new Date()
      };
      
      setAiRecommendations(prev => [newRecommendation, ...prev]);
      
      // Appeler le vrai service backend
      try {
        const response = await fetch('http://localhost:5000/ai-services/request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            type,
            deliveryMethod: newRecommendation.deliveryMethod.toLowerCase()
          })
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Service IA demand√©:', result);
        }
      } catch (backendError) {
        console.warn('Service backend non disponible, utilisation de la simulation');
      }
      
      // Simuler le traitement IA avec de vrais r√©sultats
      setTimeout(() => {
        const results = {
          profile: `üéØ Analyse de profil termin√©e !

‚úÖ Forces d√©tect√©es :
‚Ä¢ Excellente expertise technique
‚Ä¢ Portfolio diversifi√© avec ${Math.floor(Math.random() * 10) + 5} projets
‚Ä¢ Taux de satisfaction √©lev√© (${(4.2 + Math.random() * 0.8).toFixed(1)}/5)

üöÄ Suggestions d'am√©lioration :
‚Ä¢ Ajoutez 2-3 technologies tendance (Next.js, TypeScript)
‚Ä¢ Optimisez votre description avec des mots-cl√©s
‚Ä¢ Incluez des t√©moignages clients r√©cents

üìà Impact estim√© : +23% de visibilit√©, +18% de demandes`,

          market: `üìä Analyse de march√© ${new Date().toLocaleDateString()} :

üî• Votre secteur conna√Æt une croissance de +${12 + Math.floor(Math.random() * 8)}%
üí∞ Tarif recommand√© : ${Math.floor(45 * 1.1)}‚Ç¨/h (+10% sugg√©r√©)
‚≠ê Technologies demand√©es : React, TypeScript, Node.js

üìà Opportunit√©s :
‚Ä¢ E-commerce : +${25 + Math.floor(Math.random() * 10)}% de demande
‚Ä¢ Projets IA/ML : +${18 + Math.floor(Math.random() * 12)}% de croissance`,

          seo: `üîç Optimisation SEO termin√©e !

‚úÖ Points forts : Profil complet, bonnes √©valuations
üéØ Am√©liorations sugg√©r√©es :

‚Ä¢ Mots-cl√©s : "d√©veloppeur expert", "freelance qualifi√©"
‚Ä¢ Description de 150-200 mots optimis√©e
‚Ä¢ T√©moignages avec mots-cl√©s strat√©giques

üìà Impact estim√© : +${20 + Math.floor(Math.random() * 15)}% de visibilit√©`
        };

        setAiRecommendations(prev => 
          prev.map(rec => 
            rec.id === newRecommendation.id 
              ? {
                  ...rec,
                  status: 'COMPLETED' as const,
                  result: results[type as keyof typeof results] || `Analyse ${type} termin√©e avec succ√®s !`
                }
              : rec
          )
        );
      }, 3000);
      
    } catch (error) {
      console.error('Erreur lors de la demande de service IA:', error);
      setError('Erreur lors de la demande de service IA');
    }
  };

  const acceptProject = async (projectId: number) => {
    try {
      await api.post(`/projects/${projectId}/assign`);
      fetchData(); // Recharger les donn√©es
    } catch (err: any) {
      setError('Erreur lors de l\'acceptation du projet');
    }
  };

  const completeProject = async (projectId: number) => {
    try {
      await api.post(`/projects/${projectId}/done`);
      fetchData(); // Recharger les donn√©es
    } catch (err: any) {
      setError('Erreur lors de la finalisation du projet');
    }
  };

  const getStatusBadge = (statut: string) => {
    const statusStyles = {
      'EN_ATTENTE': 'badge-warning',
      'EN_COURS': 'badge-primary',
      'TERMINE': 'badge-success',
      'ANNULE': 'badge-danger'
    };
    
    const statusLabels = {
      'EN_ATTENTE': '‚è≥ En attente',
      'EN_COURS': 'üöÄ En cours',
      'TERMINE': '‚úÖ Termin√©',
      'ANNULE': '‚ùå Annul√©'
    };

    return (
      <span className={`badge ${statusStyles[statut as keyof typeof statusStyles]}`}>
        {statusLabels[statut as keyof typeof statusLabels]}
      </span>
    );
  };

  const getAIStatusIcon = (status: string) => {
    switch (status) {
      case 'PENDING': return '‚è≥';
      case 'PROCESSING': return 'üîÑ';
      case 'COMPLETED': return '‚úÖ';
      default: return '‚ùì';
    }
  };

  if (loading) {
    return (
      <div className="page-container">
        <div className="card text-center">
          <div className="loading-spinner" style={{ width: '48px', height: '48px', margin: '0 auto 1rem' }}></div>
          <p>Chargement de votre dashboard...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="page-container">
      {/* En-t√™te du dashboard */}
      <div className="card">
        <h1 className="page-title">üè† Dashboard Prestataire</h1>
        <p className="page-subtitle">G√©rez vos projets, suivez vos performances et acc√©dez aux services IA</p>
        
        {error && (
          <div className="alert alert-danger">
            <strong>‚ùå Erreur:</strong> {error}
          </div>
        )}
      </div>

      {/* Actions rapides */}
      <div className="cards-grid">
        <div className="card action-card" onClick={() => navigate('/prestataire/offers')}>
          <div className="action-icon">üìß</div>
          <h3>Demandes de Contact</h3>
          <p>G√©rer les nouvelles demandes clients</p>
          <span className="card-arrow">‚Üí</span>
        </div>

        <div className="card action-card" onClick={() => navigate('/prestataire/profile')}>
          <div className="action-icon">ÔøΩ</div>
          <h3>Mon Profil</h3>
          <p>Modifier mes informations et comp√©tences</p>
          <span className="card-arrow">‚Üí</span>
        </div>

        <div className="card action-card" onClick={() => navigate('/projects')}>
          <div className="action-icon">üìã</div>
          <h3>Tous les Projets</h3>
          <p>Vue d√©taill√©e de tous mes projets</p>
          <span className="card-arrow">‚Üí</span>
        </div>
      </div>

      {/* Statistiques principales */}
      <div className="card">
        <h2 className="section-title">üìä Mes Statistiques</h2>
        <div className="stats-grid">
          <div className="stat-card stat-primary">
            <div className="stat-icon">ÔøΩ</div>
            <div className="stat-content">
              <div className="stat-value">{stats.totalProjets}</div>
              <div className="stat-label">Total Projets</div>
            </div>
          </div>

          <div className="stat-card stat-warning">
            <div className="stat-icon">üöÄ</div>
            <div className="stat-content">
              <div className="stat-value">{stats.projetsEnCours}</div>
              <div className="stat-label">En Cours</div>
            </div>
          </div>

          <div className="stat-card stat-success">
            <div className="stat-icon">‚úÖ</div>
            <div className="stat-content">
              <div className="stat-value">{stats.projetsTermines}</div>
              <div className="stat-label">Termin√©s</div>
            </div>
          </div>

          <div className="stat-card stat-info">
            <div className="stat-icon">üí∞</div>
            <div className="stat-content">
              <div className="stat-value">{stats.chiffreAffaires.toLocaleString()}‚Ç¨</div>
              <div className="stat-label">Chiffre d'Affaires</div>
            </div>
          </div>

          <div className="stat-card stat-purple">
            <div className="stat-icon">üéØ</div>
            <div className="stat-content">
              <div className="stat-value">{stats.tauxReussite}%</div>
              <div className="stat-label">Taux de R√©ussite</div>
            </div>
          </div>

          <div className="stat-card stat-gradient">
            <div className="stat-icon">‚≠ê</div>
            <div className="stat-content">
              <div className="stat-value">{stats.noteMoyenne.toFixed(1)}/5</div>
              <div className="stat-label">Note Moyenne</div>
            </div>
          </div>
        </div>
      </div>

      {/* Services IA Recommand√©s */}
      <div className="card">
        <h2 className="section-title">ü§ñ Services IA Personnalis√©s</h2>
        <p className="section-subtitle">Boostez votre activit√© avec nos services d'intelligence artificielle</p>
        
        <div className="ai-services-grid">
          <div className="ai-service-card" onClick={() => requestAIService('profile')}>
            <div className="ai-service-icon">üéØ</div>
            <h4>Analyse de Profil IA</h4>
            <p>Analyse compl√®te de votre profil avec suggestions d'optimisation</p>
            <button className="btn btn-primary btn-sm">Lancer l'analyse</button>
          </div>

          <div className="ai-service-card" onClick={() => requestAIService('market')}>
            <div className="ai-service-icon">üìà</div>
            <h4>Analyse de March√©</h4>
            <p>Tendances et opportunit√©s de votre secteur d'activit√©</p>
            <button className="btn btn-secondary btn-sm">Analyser le march√©</button>
          </div>

          <div className="ai-service-card" onClick={() => requestAIService('seo')}>
            <div className="ai-service-icon">üîç</div>
            <h4>Optimisation SEO</h4>
            <p>Am√©liorez votre visibilit√© avec des conseils SEO personnalis√©s</p>
            <button className="btn btn-success btn-sm">Optimiser mon profil</button>
          </div>
        </div>

        {/* R√©sultats des services IA */}
        {aiRecommendations.length > 0 && (
          <div className="ai-results">
            <h3>üìã Mes Services IA</h3>
            <div className="ai-recommendations">
              {aiRecommendations.map((rec) => (
                <div key={rec.id} className="ai-recommendation-card">
                  <div className="ai-rec-header">
                    <div>
                      <h4>{rec.title}</h4>
                      <p>{rec.description}</p>
                    </div>
                    <div className="ai-rec-status">
                      <span className="ai-status-icon">{getAIStatusIcon(rec.status)}</span>
                      <span className={`badge ${rec.deliveryMethod === 'EMAIL' ? 'badge-info' : 'badge-primary'}`}>
                        {rec.deliveryMethod === 'EMAIL' ? 'üìß Email' : 'üñ•Ô∏è Frontend'}
                      </span>
                    </div>
                  </div>
                  
                  {rec.status === 'COMPLETED' && rec.result && (
                    <div className="ai-result-box">
                      <strong>üéâ R√©sultat:</strong>
                      <p>{rec.result}</p>
                      {rec.deliveryMethod === 'EMAIL' && (
                        <p className="ai-email-notice">üìß Un rapport d√©taill√© a √©t√© envoy√© √† votre adresse email.</p>
                      )}
                    </div>
                  )}
                  
                  {rec.status === 'PROCESSING' && (
                    <div className="ai-processing">
                      <div className="loading-spinner"></div>
                      <span>Traitement en cours...</span>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* Projets r√©cents */}
      <div className="card">
        <h2 className="section-title">üìÇ Mes Projets R√©cents</h2>
        {projects.length === 0 ? (
          <div className="empty-state">
            <div className="empty-icon">üì≠</div>
            <h3>Aucun projet pour le moment</h3>
            <p>Vos projets appara√Ætront ici une fois que vous en aurez accept√©.</p>
          </div>
        ) : (
          <div className="table-container">
            <table className="modern-table">
              <thead>
                <tr>
                  <th>Projet</th>
                  <th>Client</th>
                  <th>Budget</th>
                  <th>Statut</th>
                  <th>Dates</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {projects.slice(0, 5).map((project) => (
                  <tr key={project.id}>
                    <td>
                      <div className="project-info">
                        <strong>{project.titre}</strong>
                        <p>{project.description.substring(0, 60)}...</p>
                      </div>
                    </td>
                    <td>
                      <div className="client-info">
                        <strong>{project.client?.prenom} {project.client?.nom}</strong>
                        <p>{project.client?.email}</p>
                      </div>
                    </td>
                    <td>
                      <span className="budget-amount">{project.budget.toLocaleString()}‚Ç¨</span>
                    </td>
                    <td>
                      {getStatusBadge(project.statut)}
                    </td>
                    <td>
                      <div className="dates-info">
                        <div>üìÖ {new Date(project.dateDebut).toLocaleDateString()}</div>
                        <div>üèÅ {new Date(project.dateFin).toLocaleDateString()}</div>
                      </div>
                    </td>
                    <td>
                      <div className="actions-buttons">
                        {project.statut === 'EN_ATTENTE' && (
                          <button
                            onClick={() => acceptProject(project.id)}
                            className="btn btn-success btn-sm"
                          >
                            ‚úÖ Accepter
                          </button>
                        )}
                        {project.statut === 'EN_COURS' && (
                          <button
                            onClick={() => completeProject(project.id)}
                            className="btn btn-primary btn-sm"
                          >
                            üèÅ Finaliser
                          </button>
                        )}
                        <button
                          onClick={() => navigate(`/projects/${project.id}`)}
                          className="btn btn-secondary btn-sm"
                        >
                          üëÅÔ∏è Voir
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            
            {projects.length > 5 && (
              <div className="table-footer">
                <button 
                  className="btn btn-outline"
                  onClick={() => navigate('/projects')}
                >
                  Voir tous les projets ({projects.length})
                </button>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}
